import json

import pymysql
import requests


def requests_web_data(url):
    try:
        headers = {"User-Agent": "", "Cookie": ""}
        r = requests.get(url, headers=headers)
        r.raise_for_status()
        r.encoding = r.apparent_encoding
    except:
        print('requests error!')
    else:
        return r.content

def get_weibo_historical_data():
    latest_time_id_url = 'https://www.eecso.com/test/weibo/apis/getlatest.php'
    latest_time_id = json.loads(requests_web_data(latest_time_id_url).decode('utf-8'))[0]
    # 筛选获取time_id
    time_ids = []
    for x in range(241, int(latest_time_id) + 1, 360):    # time_id=48438：2020-01-01
        time_id_url = 'https://www.eecso.com/test/weibo/apis/getlatest.php?timeid=' + str(x)
        time_data = json.loads(requests_web_data(time_id_url).decode('utf-8'))
        if time_data is not None:

            time = time_data[1].split(' ')[1].split(':')[0]  # ['48798', '2020-01-01 12:00:01']
           # if time == '00' or time == '12':
            print("当前处理" + str(time_data))
            time_ids.append(time_data[0])
    if time_ids[-1] != latest_time_id:
        time_ids.append(latest_time_id)
    return time_ids


def get_weibo_hot_data(time_ids):
    weibo_hot_data = []
    for time_id in time_ids:
        historical_data_url = 'https://www.eecso.com/test/weibo/apis/currentitems.php?timeid=' + str(time_id)
        data = json.loads(requests_web_data(historical_data_url).decode('utf-8'))
        print("当前处理" + str(time_id)+"  共"+str(len(data)))
        for item in data:
            item.append(time_id)
        weibo_hot_data.append(data)
    return weibo_hot_data

def pymysql_config():
    conn = pymysql.connect(
        host='localhost',
        port=3306,
        user='root',
        password='root',
        db='weibo_hot_data',
        charset='utf8mb4'
    )
    return conn

def weibo_hot_data_insert(conn,weibohotdata):
    try:
        # 获取游标
        cursor = conn.cursor(pymysql.cursors.DictCursor)
        # 执行sql语句
        sql = "INSERT INTO weibo_hot_everyday VALUES" \
              "(%s,%s,%s,%s,%s) "
        rows = cursor.executemany(sql, weibohotdata)
        if rows > 0:
            print("入库成功" + str(rows))
            conn.commit()
            cursor.close()
            conn.close()
        else:
            print("入库失败")
            cursor.close()
            conn.close()
    except Exception as e:
        print(e)

def main():
    time_ids = ['241', '601', '961', '1321', '1681', '2041', '2401', '2761', '3121', '3481', '3841', '4201', '4561',
                '4921', '5281', '5641', '6001', '6361', '6721', '7081', '7441', '7801', '8161', '8521', '8881', '9241',
                '9601', '9961', '10321', '10681', '11041', '11401', '11761', '12121', '12481', '12841', '13201',
                '13561', '13921', '14281', '14641', '15001', '15361', '15721', '16081', '16441', '16801', '17161',
                '17521', '17881', '18241', '18601', '18961', '19321', '19681', '20041', '20401', '20761', '21121',
                '21481', '21841', '22201', '22561', '22921', '23281', '23641', '24001', '24361', '24721', '25081',
                '25441', '25801', '26161', '26521', '26881', '27241', '27601', '27961', '28321', '28681', '29041',
                '29401', '29761', '30121', '30481', '30841', '31201', '31561', '31921', '32281', '32641', '33001',
                '33361', '33721', '34081', '34441', '34801', '35161', '35521', '35881', '36241', '36601', '36961',
                '37321', '37681', '38041', '38401', '38761', '39121', '39481', '39841', '40201', '40561', '40921',
                '41281', '41641', '42001', '42361', '42721', '43081', '43441', '43801', '44161', '44521', '44881',
                '45241', '45601', '45961', '46321', '46681', '47041', '47401', '47761', '48121', '48481', '48841',
                '49201', '49561', '49921', '50281', '50641', '51001', '51361', '51721', '52081', '52441', '52801',
                '53161', '53521', '53881', '54241', '54601', '54961', '55321', '55681', '56041', '56401', '56761',
                '57121', '57481', '57841', '58201', '58561', '58921', '59281', '59641', '60001', '60361', '60721',
                '61081', '61441', '61801', '62161', '62521', '62881', '63241', '63601', '63961', '64321', '64681',
                '65041', '65401', '65761', '66121', '66481', '66841', '67201', '67561', '67921', '68281', '68641',
                '69001', '69361', '69721', '70081', '70441', '70801', '71161', '71521', '71881', '72241', '72601',
                '72961', '73321', '73681', '74041', '74401', '74761', '75121', '75481', '75841', '76201', '76561',
                '76921', '77281', '77641', '78001', '78361', '78721', '79081', '79441', '79801', '80161', '80521',
                '80881', '81241', '81601', '81961', '82321', '82681', '83041', '83401', '83761', '84121', '84481',
                '84841', '85201', '85561', '85921', '86281', '86641', '87001', '87361', '87721', '88081', '88441',
                '88801', '89161', '89521', '89881', '90241', '90601', '90961', '91321', '91681', '92041', '92401',
                '92761', '93121', '93481', '93841', '94201', '94561', '94921', '95281', '95641', '96001', '96361',
                '96721', '97081', '97441', '97801', '98161', '98521', '98881', '99241', '99601', '99961', '100321',
                '100681', '101041', '101401', '101761', '102121', '102481', '102841', '103201', '103561', '103921',
                '104281', '104641', '105001', '105361', '105721', '106081', '106441', '106801', '107161', '107521',
                '107881', '108241', '108601', '108961', '109321', '109681', '110041', '110401', '110761', '111121',
                '111481', '111841', '112201', '112561', '112921', '113281', '113641', '114001', '114361', '114721',
                '115081', '115441', '115801', '116161', '116521', '116881', '117241', '117601', '117961', '118321',
                '118681', '119041', '119401', '119761', '120121', '120481', '120841', '121201', '121561', '121921',
                '122281', '122641', '123001', '123361', '123721', '124081', '124441', '124801', '125161', '125521',
                '125881', '126241', '126601', '126961', '127321', '127681', '128041', '128401', '128761', '129121',
                '129481', '129841', '130201', '130561', '130921', '131281', '131641', '132001', '132361', '132721',
                '133081', '133441', '133801', '134161', '134521', '134881', '135241', '135601', '135961', '136321',
                '136681', '137041', '137401', '137761', '138121', '138481', '138841', '139201', '139561', '139921',
                '140281', '140641', '141001', '141361', '141721', '142081', '142441', '142801', '143161', '143521',
                '143881', '144241', '144601', '144961', '145321', '145681', '146041', '146401', '146761', '147121',
                '147481', '147841', '148201', '148561', '148921', '149281', '149641', '150001', '150361', '150721',
                '151081', '151441', '151801', '152161', '152521', '152881', '153241', '153601', '153961', '154321',
                '154681', '155041', '155278']

    # time_ids = [241,601]
    weibo_hot_data_list = get_weibo_hot_data(time_ids=time_ids)
    '''if(len(time_ids)==len(weibo_hot_data_list)):
        print("数据全部获取成功")
    else:
        print("time_ids:"+str(len(time_ids)))
        print("weibo_hot_data_list:"+len(weibo_hot_data_list))
    '''

    for daydata in weibo_hot_data_list:
        conn = pymysql_config()
        weibo_hot_data_insert(conn, daydata)

#main()
#print(get_weibo_historical_data())
print(requests_web_data("https://s.weibo.com/top/summary").decode('utf-8'))